.PHONY: all clean test

SRCDIR=$(dir .)
TESTDIR=$(dir ./test)

FILES[] =
	util
	logger
	type
	id
	m
	s
	syntax
	parser
	lexer
	typing
	kNormal
	alpha
	beta
	assoc
	inline
	constFold
	elim
	closure
	asm
	virtual
	interp
	emitVirtual
	interpMain

TESTS[] =
	print
	sum-tail
	gcd
	sum
	fib
	ack
	even-odd
	adder
	#funcomp
	cls-rec
	cls-bug
	cls-bug2
	cls-reg-bug
	shuffle
	spill
	spill2
	spill3
	join-stack
	join-stack2
	join-stack3
	join-reg
	join-reg2
	non-tail-if2
	array

UNSUPPORTED[] =
	non-tail-if
	inprod
	inprod-loop
	inprod-rec
	matmul
	matmul-flat

PROGRAM = min-camli
USE_OCAMLFIND = true

OCAMLPACKS[] =
	ounit

# OCAML_LIBS +=
# OCAML_CLIBS +=
# OCAML_OTHER_LIBS +=
# OCAML_LIB_FLAGS +=

OCamlGeneratedFiles(lexer.ml parser.mli parser.ml)

.DEFAULT: $(OCamlProgram $(PROGRAM), $(FILES))

.PHONY: test
test:
	make -s test
	foreach(t, $(TESTS)):
		echo ""
		echo "=========== $t =========="
		echo "[TEST]"
		echo ""
		./$(PROGRAM) test/$(t)
		echo ""
		./test/$(t)
		echo ""
		echo "[EXECUTED]"

.PHONY: clean
clean:
  rm -f \
     $(filter-proper-targets $(glob $(addsuffix .*, $(FILES)))) \
     $(PROGRAM).run $(PROGRAM).opt $(PROGRAM) && \
     make clean -s
